# 独立看门狗

[独立看门狗https://www.bilibili.com/video/BV1Lx411Z7Qa?p=28](https://www.bilibili.com/video/BV1Lx411Z7Qa?p=28)

[P1 独立看门狗概述](#独立看门狗概述)

[P2 常用寄存器和库函数配置](#常用寄存器和库函数配置)

[P3 实验](#实验)

## 独立看门狗概述

### 1. 为什么需要看门狗

- 在有单片机构成的微型计算机系统中，由于单片机的工作常常会受到来自外界电磁场的干扰，造成程序的跑飞，而陷入死循环，程序的正常运行被打断，由单片机控制的系统无法继续工作，会造成整个系统陷入停滞状态，发送不可预料的后果，所以出于对单片机运行状态进行实时监测的考虑，便产生了一种专门用于监测单片机程序运行状态的模块或者芯片，俗称“看门狗”（WatchDog）。

### 2. 看门狗解决的问题是什么

- 在启动正常运行的时候，系统不能复位
- 在系统跑飞（程序异常执行）的情况，系统复位，程序重新执行

- STM32有两个看门狗，提供了更高的安全性，时间的精确性和使用的灵活性。两个看门狗设备（独立看门狗/窗口看门狗）可以用来检测和解决有软件错误引起的故障。当计时器达到给定的超时值时，触发一个中断（仅适用窗口看门狗）或者产生系统复位。

- 独立看门狗（IWDG）有专门的低速时钟（LSI）驱动，即使时钟发生故障它仍有效。

  - 独立看门狗适合应用于需要看门狗作为一个在主程序之外能够完全独立工作，并且对时间精度要求低的场合

- 窗口看门狗有从APB1时钟分频后得到时钟驱动。通过可配置的时间窗口来检测应用程序非正常的过迟或过早操作。

  - 窗口看门狗最适合那些要求看门狗在精确计时窗口起作用的程序。

### 3. 独立看门狗功能描述

- 在键值寄存器（IWDG_KR）中写入0xCCCC，开始启用独立看门狗。此时计数器开始从其复位值0xFFF递减，当计数器到位置0x000时会产生一个复位信号（IWDG_RESET）

- 无论何时，只要在键值寄存器IWDG_KR中写入0xAAAA（通常说喂狗），自动重装载寄存器IWDG_RLR的值就会重新加载到计数器，从而避免看门狗复位

- 如果程序异常，就无法正常喂狗，从而系统复位。

![独立看门狗](../image/独立看门狗.jpg)

- 键值寄存器IWDG_KR：0 ~ 15位有效

- 预分频寄存器IWDG_PR：0 ~ 2位有效(具有写保护功能，要操作先取消写保护)

- 重装载寄存器IWDG_RLR：0 ~ 11位有效(具有写保护功能，要操作先取消写保护)

- 状态寄存器IWDG_SR：0 ~ 1位有效

![独立看门狗超时时间](../image/独立看门狗超时时间.jpg)

## 常用寄存器和库函数配置

### 独立看门狗库函数

- IWDG独立看门狗操作库函数

```C
//参数省略
//取消写保护：0x5555使能
void IWDG_WriteAccessCmd(uint16_t IWDG_WriteAccess);
//设置预分频系数：写PR
void IWDG_SetPrescaler(uint8_t IWDG_Prescaler);
//设置重装载值：写RLR
void IWDG_SetReload(uint16_t Reload);
//喂狗：写0xAAAA到KR
void IWDG_ReloadCounter(void);
//使能看门狗：写0xCCCC到KR
void IWDG_Enable(void);
//状态：重装载/预分频更新
FlagStatus IWDG_GetFlagStatus(uint16_t IWDG_FLAG);
```

- 独立看门狗操作步骤

```C
//参数省略
//1.取消寄存器写保护
IWDG_WriteAccessCmd();
//2.设置独立看门狗的预分频系数，确定时钟
IWDG_SetPrescaler();
//3.设置看门狗重装载值，确定溢出时间
IWDG_SetReload();
//使能看门狗
IWDG_Enable();
//应用程序喂狗
IWDG_ReloadCounter();
```

- 溢出时间计算

```C
Tout = ((4 * 2 ^ prep) * rlr) / 40   (M3)
```

## 实验
